name: Health Check

on:
  schedule:
    # Check every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  health-check:
    name: üè• Production Health Check
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          
      - name: üìö Install dependencies
        run: npm ci
        
      - name: üè• Check application health
        run: |
          # Get the production URL from Vercel deployment
          PROD_URL="https://bangerrequest-8sasrdwae-mommys-projects-f4f4fbbb.vercel.app"
          # If the app uses a basePath, set it here (must match next.config.ts)
          BASE_PATH="/richiedi"
          # Vercel Protection Bypass for CI/CD (requires VERCEL_PROTECTION_BYPASS secret)
          BYPASS_PARAM=""
          if [ -n "${{ secrets.VERCEL_PROTECTION_BYPASS }}" ]; then
            BYPASS_PARAM="?x-vercel-set-bypass-cookie=true&x-vercel-protection-bypass=${{ secrets.VERCEL_PROTECTION_BYPASS }}"
          fi
          
          echo "üîç Checking health endpoints..."
          
          # Check main health endpoint (respect basePath)
          response=$(curl -s -o /dev/null -w "%{http_code}" "${PROD_URL}${BASE_PATH}/api/health${BYPASS_PARAM}" || echo "000")
          if [ "$response" = "200" ]; then
            echo "‚úÖ Main health check passed"
          else
            echo "‚ùå Main health check failed (HTTP $response)"
            exit 1
          fi
          
          # Check Supabase health
          response=$(curl -s -o /dev/null -w "%{http_code}" "${PROD_URL}${BASE_PATH}/api/health/supabase${BYPASS_PARAM}" || echo "000")
          if [ "$response" = "200" ]; then
            echo "‚úÖ Supabase health check passed"
          else
            echo "‚ö†Ô∏è Supabase health check failed (HTTP $response)"
          fi
          
          # Check Spotify health
          response=$(curl -s -o /dev/null -w "%{http_code}" "${PROD_URL}${BASE_PATH}/api/spotify/health${BYPASS_PARAM}" || echo "000")
          if [ "$response" = "200" ]; then
            echo "‚úÖ Spotify health check passed"
          else
            echo "‚ö†Ô∏è Spotify health check failed (HTTP $response)"
          fi
          
          # Check main page loads (basePath root)
          response=$(curl -s -o /dev/null -w "%{http_code}" "${PROD_URL}${BASE_PATH}/${BYPASS_PARAM}" || echo "000")
          if [ "$response" = "200" ]; then
            echo "‚úÖ Homepage loads successfully"
          else
            echo "‚ùå Homepage failed to load (HTTP $response)"
            exit 1
          fi
          
          echo "üéâ Health check completed successfully!"
          
      - name: üìä Run detailed health check
        run: |
          node scripts/check_health.cjs https://bangerrequest-8sasrdwae-mommys-projects-f4f4fbbb.vercel.app/api/health/supabase
          
      - name: üí¨ Notify on failure
        if: failure()
        run: |
          echo "‚ùå Health check failed! Production may be down."
          echo "Check the application immediately: https://bangerrequest-8sasrdwae-mommys-projects-f4f4fbbb.vercel.app"