name: Health Check

on:
  schedule:
    # Check every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  health-check:
    name: üè• Production Health Check
    runs-on: ubuntu-latest
    env:
      PROD_URL: ${{ secrets.PROD_URL }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          
      - name: üìö Install dependencies
        run: npm ci
      - name: üè• Check application health (critical)
        run: |
          set -euo pipefail

          if [ -z "${PROD_URL}" ]; then
            echo "‚ùå PROD_URL secret is not set. Add it in repository Settings ‚Üí Secrets."
            exit 1
          fi

          echo "üîç Checking critical health endpoints: ${PROD_URL}"

          check() {
            url="$1"
            for i in 1 2 3; do
              if curl -fsS --max-time 10 "$url" -o /dev/null; then
                echo "‚úÖ $url OK"
                return 0
              fi
              echo "Retry $i for $url"
              sleep 2
            done
            echo "‚ùå $url failed after retries"
            return 1
          }

          check "${PROD_URL}/api/health"
          check "${PROD_URL}/"

      - name: ‚ö†Ô∏è Check Supabase (non-critical)
        continue-on-error: true
        run: |
          set -uo pipefail
          curl -fsS --max-time 8 --retry 2 "${PROD_URL}/api/health/supabase" -o /dev/null || echo "Supabase check failed"

      - name: ‚ö†Ô∏è Check Deezer (non-critical)
        continue-on-error: true
        run: |
          set -uo pipefail
          curl -fsS --max-time 8 --retry 2 "${PROD_URL}/api/deezer/health" -o /dev/null || echo "Deezer check failed"

      - name: üìä Run detailed health check
        run: |
          node scripts/check_health.cjs "${PROD_URL}/api/health/supabase"

      - name: üí¨ Notify on failure
        if: failure()
        run: |
          echo "‚ùå Health check failed! Production may be down."
          echo "Check the application immediately: ${PROD_URL}"

          if [ -n "${TELEGRAM_BOT_TOKEN}" ] && [ -n "${TELEGRAM_CHAT_ID}" ]; then
            MESSAGE="‚ùå Health check failed for ${GITHUB_REPOSITORY}.\nWorkflow: ${GITHUB_WORKFLOW}\nRun: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}\nApp: ${PROD_URL}"

            curl -fsS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              --data-urlencode "chat_id=${TELEGRAM_CHAT_ID}" \
              --data-urlencode "text=${MESSAGE}" \
              --data-urlencode "disable_web_page_preview=true" || echo "Telegram notification failed"
          else
            echo "Telegram secrets missing, skipping alert"
          fi