name: Health Check

on:
  schedule:
    # Check every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  health-check:
    name: ğŸ¥ Production Health Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          
      - name: ğŸ“š Install dependencies
        run: npm ci
        
      - name: ğŸ¥ Check application health
        run: |
          # Get the production URL from Vercel deployment
          PROD_URL="https://bangerrequest-8sasrdwae-mommys-projects-f4f4fbbb.vercel.app"
          
          echo "ğŸ” Checking health endpoints..."
          
          # Check main health endpoint
          response=$(curl -s -o /dev/null -w "%{http_code}" "$PROD_URL/api/health" || echo "000")
          if [ "$response" = "200" ]; then
            echo "âœ… Main health check passed"
          else
            echo "âŒ Main health check failed (HTTP $response)"
            exit 1
          fi
          
          # Check Supabase health
          response=$(curl -s -o /dev/null -w "%{http_code}" "$PROD_URL/api/health/supabase" || echo "000")
          if [ "$response" = "200" ]; then
            echo "âœ… Supabase health check passed"
          else
            echo "âš ï¸ Supabase health check failed (HTTP $response)"
          fi
          
          # Check Spotify health
          response=$(curl -s -o /dev/null -w "%{http_code}" "$PROD_URL/api/spotify/health" || echo "000")
          if [ "$response" = "200" ]; then
            echo "âœ… Spotify health check passed"
          else
            echo "âš ï¸ Spotify health check failed (HTTP $response)"
          fi
          
          # Check main page loads
          response=$(curl -s -o /dev/null -w "%{http_code}" "$PROD_URL/" || echo "000")
          if [ "$response" = "200" ]; then
            echo "âœ… Homepage loads successfully"
          else
            echo "âŒ Homepage failed to load (HTTP $response)"
            exit 1
          fi
          
          echo "ğŸ‰ Health check completed successfully!"
          
      - name: ğŸ“Š Run detailed health check
        run: |
          node scripts/check_health.js https://bangerrequest-ffdp6sj3d-mommys-projects-f4f4fbbb.vercel.app/api/health/supabase
          
      - name: ğŸ’¬ Notify on failure
        if: failure()
        run: |
          echo "âŒ Health check failed! Production may be down."
          echo "Check the application immediately: https://bangerrequest-ffdp6sj3d-mommys-projects-f4f4fbbb.vercel.app"